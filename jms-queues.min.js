!function(a,b){if("function"==typeof define&&define.amd)define([],b);else if("object"==typeof exports){var c=b();"object"==typeof module&&module&&module.exports&&(exports=module.exports=c),exports.JmsQueueVisualizer=c}else a.JmsQueueVisualizer=b()}(this,function(){var a=function(a){function q(){var a=this;a.numTimesRan=ko.observable(-1),a.getTime=ko.pureComputed(function(){var b=a.numTimesRan()*h,c=Math.floor(b/60),d=Math.floor(c/60),e=b%60,f=c%60,g=e+"s ",i=c>0?f+"m ":"",j=d>0?d+"h ":"";return"Total run time: "+j+i+g},a),a.increment=function(){a.numTimesRan(a.numTimesRan()+1)}}function r(a){var b=this;b.type=ko.observable(a),b.name=ko.observable(""),b.value=ko.observable(0),b.leaderChanged=ko.observable(!1),b.getColor=ko.pureComputed(function(){return"leaderboard__row--"+(b.leaderChanged()?"changed":"no-change")},b),b.check=function(a,c,d){c>b.value()&&b.update(a,c)},b.update=function(a,c){b.leaderChanged(a!==b.name()||c>b.value()),b.name(a),b.value(c)},b.clearLeaderChange=function(){b.leaderChanged(!1)}}function s(){var a=this;a.maxQueue=ko.observable(new r("Max Depth")),a.bestAvg=ko.observable(new r("Processed/Sec (15 sec avg)")),a.bestTotalAvg=ko.observable(new r("Processed/Sec (5 min avg)")),a.clearLeaderChange=function(){a.maxQueue().clearLeaderChange(),a.bestAvg().clearLeaderChange(),a.bestTotalAvg().clearLeaderChange()},a.values=ko.observableArray([a.maxQueue,a.bestAvg,a.bestTotalAvg])}function t(a){var b=this,c=a.queues.length,e=document.getElementById("chart"),f=e.getContext("2d"),g=$("#chart-sub-container");b.queues=ko.observableArray([]),b.leaderboard=ko.observable(new s),b.runtime=ko.observable(new q),b.useSimpleImg=ko.observable(!1),b.toggleImages=function(){b.useSimpleImg(!b.useSimpleImg())},b.imageText=ko.pureComputed(function(){return b.useSimpleImg()?"Use Fun Racers":"Use Boring Racers"},b),e.width=g.width(),e.height=g.height(),b.chart=new Chart(f,{type:"line",data:{labels:[],datasets:[]},options:{maintainAspectRatio:!1,responsive:!0,scales:{xAxes:[{display:!1}]}}}),setTimeout(function(){$("iframe").css("height","100%").css("position","relative"),setTimeout(function(){$("iframe").css("height",0),$("#chart-sub-container").css("height","200px").css("width","600px").css("margin-left","50px")},200)},200);for(var h=0;h<a.queues.length;h++){var i=a.queues[h],j=new u(i.name,i.requestData,h);b.queues.push(ko.observable(j)),n(b.chart,j)}b.update=function(){for(var d=$.Deferred(),e=c,f=0;f<a.queues.length;f++)b.queues()[f]().update(a.requestMethod,b.runtime().numTimesRan(),a.refreshInSec).then(function(){0===--e&&d.resolve()});d.then(function(){var a=0,c="",d=0,e="";b.leaderboard().clearLeaderChange(),$.each(b.queues(),function(f,g){var h=g().name();b.leaderboard().maxQueue().check(h,g().maxPending()),g().avgProcessedPerSec()>a&&(a=g().avgProcessedPerSec(),c=h),g().totalAvgProcessedPerSec()>d&&(d=g().totalAvgProcessedPerSec(),e=h)}),b.leaderboard().bestAvg().update(c,a),b.leaderboard().bestTotalAvg().update(e,d),b.runtime().increment(),o(b.chart.data.labels,b.runtime().numTimesRan()),b.chart.update()})}}function u(a,b,c){var d=this;d.name=ko.observable(a),d.requestData=b,d.previousTotalInbound=-1,d.color=ko.observable(randomColor({luminosity:"light"})),d.racer=ko.observable({name:"racer-"+d.name(),direction:1,numLaps:ko.observable(0),sourceImage:ko.observable(m(c++)),trackIndex:c}),d.numConsumers=ko.observable(0),d.numPending=ko.observable(0),d.maxPending=ko.observable(0),d.numProcessed=ko.observable(0),d.avgProcessedPerSec=ko.observable(0),d.totalAvgProcessedPerSec=ko.observable(0),d.update=function(a,b,c){var f=$.Deferred();return a(d,d.requestData,c).then(function(a){d.numConsumers(a.numConsumers),d.numPending(a.numPending),d.maxPending(a.maxPending),d.numProcessed(a.numProcessed),d.avgProcessedPerSec(a.avgProcessedPerSec),d.totalAvgProcessedPerSec(a.totalAvgProcessedPerSec),p(20*d.avgProcessedPerSec(),d.racer()),o(d.dataset.data,{x:(b+1)*c,y:Math.floor(d.avgProcessedPerSec())}),f.resolve()}).fail(function(a){console.log("failed on refresh: "+e),clearInterval(updateInterval)}),f}}if(!a)throw new Error("Cannot create Queue Visualizer with no options");if(!a.queues)throw new Error("Cannot create Queue Visualizer with no queues");for(var b=["//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js","https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js","https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.3.0/Chart.min.js","https://cdnjs.cloudflare.com/ajax/libs/randomcolor/0.4.4/randomColor.min.js"],c=0;c<b.length;c++){var d=document.createElement("script");d.src=b[c],document.getElementsByTagName("head")[0].appendChild(d)}setTimeout(function(){v()},500);var f=[],g="https://media.giphy.com/media/DVWVJxLvLSc92/giphy.gif",h=a.refreshInSec||15,i=1e3*h,j=(a.graphLengthMinutes||30)*Math.floor(60/h),k=function(a){return Math.floor(Math.random()*a)},l=function(){console.log("refreshing source..."),$.get("https://rawgit.com/master-elodin/jms-queue-made-fun/master/img-sources.txt").then(function(a){srcImg=a.split("\n"),""===srcImg[srcImg.length-1]&&srcImg.pop()})},m=function(a){for(var b=k(srcImg.length);f.indexOf(b)>-1;)b=k(srcImg.length);return f[a]=b,srcImg[b]},n=function(a,b){b.dataset={label:b.name(),borderColor:b.color(),fill:!1,data:[]},a.data.datasets.push(b.dataset)},o=function(a,b){a.length>j&&a.shift(),a.push(b)},p=function(a,b){var c=$("#"+b.name),d=c.width(),e=$(window).width(),f=c.css("left"),f=parseInt(f.substring(0,f.length-2)),h=f+a*b.direction,j=10,k=e-d-20,l=Math.min(Math.max(h,j),k);(f>0&&l===j||l===k)&&(b.direction=b.direction*-1,1===b.direction&&setTimeout(function(){b.numLaps(b.numLaps()+1)},Math.max(i-1e3,0)),setTimeout(function(){b.sourceImage(g),setTimeout(function(){b.sourceImage(m(b.trackIndex))},800)},Math.max(i-1e3,0))),l<f?c.css("transform","scaleX(-1)"):c.css("transform","scaleX(1)"),c.stop(!0,!0),c.animate({left:l+"px"},i)},v=function(){l(),setTimeout(function(){$("body").html('<div class=queue-overall-container id=container><table class=queue-list><thead><tr><th class="queue-list-header queue-list__name">Queue Name<th class="queue-list-header queue-list__consumers">Consumers<th class="queue-list-header queue-list__depth">Queue Depth<th class="queue-list-header queue-list__max-depth">Max Depth<th class="queue-list-header queue-list__proc">Processed<br>(15 sec)<th class="queue-list-header queue-list__avg-processed-sec-short">Processed/Sec<br>(15 sec avg)<th class="queue-list-header queue-list__avg-processed-sec-long">Processed/Sec<br>(5 min avg)<th class="queue-list-header queue-list__laps">Laps<tbody data-bind="foreach: queues"><tr data-bind="style: { color: color }"class=queue-list-entry__row><td data-bind="text: name"class=queue-list-entry__name><td data-bind="text: numConsumers"><td data-bind="text: numPending"><td data-bind="text: maxPending"><td data-bind="text: numProcessed"><td data-bind="text: avgProcessedPerSec"><td data-bind="text: totalAvgProcessedPerSec"><td data-bind="text: racer().numLaps"></table><div class=queue-combined-container><div class=runtime-toggle-container><div class=runtime-container data-bind="with: runtime"><span data-bind="text: getTime()"></span></div><div class=button-container><span data-bind="click: toggleImages, text: imageText"class=button></span></div></div><table class=leaderboard data-bind="with: leaderboard"><thead class=leaderboard-header><tr><th class=leaderboard-header__name>Queue<th class=leaderboard-header__category>Category<th>Points<tbody data-bind="foreach: values"><tr data-bind="style: { color: getColor() }"><td data-bind="text: name"><td data-bind="text: type"><td data-bind="text: value"></table><div class=graph-top-parent><div id=chart-sub-container><canvas height=200 id=chart width=600></canvas></div></div></div><div class=race-container data-bind="foreach: queues"><div class=racer-row><span data-bind="text: name"class=racer-row__name></span><div class=racer-row__racer-container data-bind="attr: { id: racer().name }"><img class="racer racer-image"data-bind="attr: {src: racer().sourceImage}, visible: !$root.useSimpleImg()"> <svg class="racer racer-dot"data-bind="visible: $root.useSimpleImg, style: {fill: color}"viewBox="0 0 100 100"xmlns=http://www.w3.org/2000/svg><circle cx=40 cy=40 r=40 /></svg></div></div></div></div>');var b=document.createElement("link");b.rel="stylesheet",b.type="text/css",b.href="https://rawgit.com/master-elodin/jms-queue-made-fun/master/assets/stylesheets/jms-queues.css",document.getElementsByTagName("head")[0].appendChild(b);var c=new t(a);ko.applyBindings(c),c.update();setInterval(function(){console.log("Updating..."),c.update(),console.log("Finished updating"),c.runtime().numTimesRan()%8===0&&l()},i)},500)}};return a});